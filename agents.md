## Agents and AI in this codebase

This document explains how AI “agents” are wired into the app, how we generate and persist Personas using the Vercel AI SDK v5, and how this integrates with Convex. It also codifies Convex best practices relevant to our flows.

### Architecture at a glance
- **UI**: Next.js App Router, server components preferred; client components only when needed.
- **AI**: Vercel AI SDK v5 (`ai`, `@ai-sdk/google`) with Gemini and structured outputs via `generateObject`.
- **Domain**: Standardized personas with strong typing and Zod validation.
- **Backend**: Convex actions/mutations/queries for AI calls and persistence.

Key files:
- `lib/personas/personaGroups.ts`: group catalog + derived helpers.
- `lib/personas/types.ts`: TS interfaces for Persona and related shapes.
- `lib/personas/schemas.ts`: Zod schemas mirroring the interfaces (strict JSON validation).
- `lib/personas/prompt.ts`: prompt builder for persona generation.
- `convex/personas.ts`: Convex action `generate` (AI call), action `generateForGroups` (orchestrator), queries, and mutation `saveMany` (persistence).
- `convex/personaGroups.ts`: Convex action `suggest` (audience → group subsegments).
- `convex/ads.ts`: Convex action `generateVariants` (ad variants).
- `convex/simulation.ts`: Convex action `simulate` (persona reactions to ads).
- `convex/schema.ts`: Convex tables; includes `personas` table.

### Persona generation agent
- Uses `generateObject` (non‑streaming) with `google('gemini-2.5-pro')` to return validated `Persona[]`.
- `Persona` fields include OCEAN personality scores, profile, and pre‑ad context. The `scenario`, `current_activity`, and `emotional_state` inside `pre_ad_context` are derived by the model (not inputs).
- Inputs: `{ group, count, context?: { location? } }`.

Why structured outputs: Zod schemas are enforced at generation time, preventing malformed data and reducing ad‑hoc validation.

### Data persistence (Convex)
- Table: `personas` mirrors the `Persona` structure. Results generated by the action are persisted via `saveMany`.
- Indexes:
  - `by_group` on `personaGroup` for fast filtering.
  - `by_persona_id` on `persona_id` for quick lookups.

### Usage examples
Server component calling Convex action (preferred):
```ts
import { api } from '@/convex/_generated/api';
import { fetchAction } from 'convex/nextjs';

const personas = await fetchAction(api.personas.generate, {
  group: 'fitness',
  count: 2,
  context: { location: 'Austin, TX' },
});
```

Server action (alternative) returning `Persona[]` without persistence:
```ts
import { generatePersonas } from '@/lib/personas/generate';

const personas = await generatePersonas({
  group: 'tech',
  count: 3,
  context: { location: 'San Francisco, CA' },
});
```

Audience → groups (subsegments) example:
```ts
import { api } from '@/convex/_generated/api';
import { fetchAction } from 'convex/nextjs';

const groups = await fetchAction(api.personaGroups.suggest, {
  text: 'Young professionals seeking eco‑friendly commuting options',
  location: 'Austin, TX',
  count: 6,
});
```

Ad variants example:
```ts
const variants = await fetchAction(api.ads.generateVariants, {
  count: 3,
  source: { headline: 'Boost recovery', description: 'Plant‑based protein 20g, clean formula.' },
});
```

Simulation example:
```ts
const reactions = await fetchAction(api.simulation.simulate, { persona, ads });
```

### Error handling and safety
- `generateObject` may throw `NoObjectGeneratedError`. We log provider details (cause, text, response, usage) and rethrow.
- Cap `count` (e.g., 1–10) to control cost/latency.
- Avoid logging sensitive content; keep `chain_of_thought` concise.

### Environment & configuration
- Set `GOOGLE_GENERATIVE_AI_API_KEY` in Convex: `npx convex env set GOOGLE_GENERATIVE_AI_API_KEY <key>`.
- Ensure `ai`, `@ai-sdk/google`, and `zod` are installed.

### Convex development guide (best practices)
- TypeScript: concise, functional style; descriptive variable names; prefer `interface` over type aliases for objects.
- Components: export named components; decompose into subcomponents/helpers; keep client components minimal.
- Errors: fail early; log actionable details; surface user‑friendly messages; validate inputs with Zod on boundaries.
- UI: shadcn/ui, Radix primitives, Tailwind; responsive, mobile‑first.
- Performance: minimize `use client`, state, and effects; prefer RSC; use `Suspense`; dynamic import heavy UI; optimize images.
- URLs/State: prefer `nuqs` (URL state) when applicable; watch Core Web Vitals; keep `useClient` limited.
- Convex data: prefer indexed queries over `.filter()` chains. Define indexes in `schema.ts` and query with `.withIndex(...)`.
- Actions vs mutations vs queries:
  - Use **actions** for external network I/O (e.g., calling AI providers), then commit via **mutations**.
  - Use **queries** for reads; paginate or cap results.
- HTTP Router & scheduled jobs: keep handlers small, validate inputs, and reuse domain helpers.
- File handling: upload via generated URL, then persist storage IDs in mutations.

Index example (messages table):
```ts
// schema.ts
defineTable({
  channel: v.id('channels'),
  body: v.string(),
  user: v.id('users'),
})
  .index('by_channel', ['channel'])
  .index('by_channel_user', ['channel', 'user']);

// query
await ctx.db
  .query('messages')
  .withIndex('by_channel', q => q.eq('channel', channel))
  .collect();
```

### Extensibility roadmap
- Add ad and reaction generators using the same `generateObject` pattern with dedicated Zod schemas.
- Add Convex queries to fetch personas by `personaGroup` and `persona_id` using indexes.
- Optional: a streaming variant (`streamObject`) for interactive UIs.
- Add rate limiting/quotas per user for generation endpoints.

### Quick checklist
- [ ] Inputs validated with Zod
- [ ] Results persisted via Convex mutation
- [ ] Indexes defined for query patterns
- [ ] Sensitive fields not logged; concise reasoning
- [ ] Client components minimized; RSC where possible

### UI notes
- Personas are visualized in `app/product/simulation/workflow/page.tsx` using a shadcn `AvatarGroup` with hover tooltips summarizing the persona.


